<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="geosite,geosite.dat">
  <title>Geosite解析</title>
  <script src="https://cdn.jsdmirror.cn/npm/protobufjs@8.0.0/dist/protobuf.min.js"></script>
  <style type="text/css">
    html,
    body {
      margin: 0px;
      padding: 0px;
    }

    .category-item {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div style="display: flex;margin-left: 80px;">
    <input id="file-choose" type="file" accept="*.dat" name="选择文件">
    <input id="start-button" style="margin-left: 40px;" type="button" value="开始解析">
  </div>
  <div style="display: flex;margin-top: 30px;">
    <div style="margin-left: 80px;">
      <div>类别列表</div>
      <input id="search-input" placeholder="过滤类别" />
      <div id="category-list-box" style="width: 10vw;height: 80vh;border: 1px solid #333;overflow-y: auto;"></div>
    </div>
    <div style="margin-left: 80px;">
      <div>域名列表</div>
      <div></div>
      <div id="domain-list-box" style="width: 30vw;height: 80vh;border: 1px solid #333;overflow-y: auto;"></div>
    </div>
    <div style="margin-left: 80px;">
      <div>搜索所有域名</div>
      <div style="display: flex;">
        <input placeholder="搜索域名" />
        <input onclick="searchAllDomain(this)" style="margin-left: 40px;" type="button" value="搜索">
      </div>
      <div id="search-domain-box" style="width: 40vw;height: 80vh;border: 1px solid #333;overflow-y: auto;"></div>
    </div>
  </div>
</body>
<script type="text/javascript">
  const domainTypeMap = Object.freeze(['plain', 'regex', 'domain', 'full']);
  let datFile = null;
  let parseResult = null;
  const categories = [];
  const fileChoose = document.getElementById('file-choose');
  fileChoose.addEventListener('change', (e) => {
    datFile = e.target.files[0];
  })

  document.getElementById('start-button').addEventListener('click', () => {
    if (!datFile) {
      alert('未选择文件');
      return;
    }
    parseFile();
  })

  function chooseCategory(e) {
    const cateName = e.getAttribute('category');
    renderDomain(cateName);
  }

  function renderDomain(categoryName) {
    const domain = parseResult.find(item => item.category === categoryName);
    if (domain) {
      const domainListBox = document.getElementById('domain-list-box');
      domainListBox.parentElement.querySelector('div:nth-child(2)').innerHTML = `当前类别：${categoryName}`;
      domainListBox.innerHTML = domain.domain.map(item => {
        const attrs = item.attribute.map(attr => `<span style="margin-left:2px;color:purple;">@${attr.key}</span>`).join('');
        return `<div>
          <span style="color:green;">${domainTypeMap[item.type]}:</span>
          <span style="margin-left:2px">${item.value}</span>
          ${attrs}
          </div>
          `;
      }).join('');
    }
  }

  async function parseFile() {
    const { root } = protobuf.parse(`
    syntax = "proto3";
    message Domain {
  enum Type {}

  Type type = 1;
  string value = 2;

  message Attribute {
    string key = 1;
  }

  repeated Attribute attribute = 3;
}

message GeoSite {
  string category = 1;
  repeated Domain domain = 2;
}

message GeoSiteList {
  repeated GeoSite entry = 1;
}`);
    const messageType = root.lookupType('GeoSiteList');
    const fileBuffer = await datFile.arrayBuffer();
    const message = messageType.decode(new Uint8Array(fileBuffer));
    parseResult = message.entry;
    for (const item of message.entry) {
      categories.push(item.category);
    }
    categories.sort();
    document.getElementById('category-list-box').innerHTML = categories.map((item) => `<div class="category-item" category="${item}" onclick="chooseCategory(this)">${item.toLowerCase()}</div>`).join('');
  }

  document.getElementById('search-input').addEventListener('input', e => {
    const keyword = e.target.value.trim().toUpperCase();
    if (keyword) {
      const searchList = categories.filter(item => item.includes(keyword));
      document.getElementById('category-list-box').innerHTML = searchList.map((item) => `<div class="category-item" category="${item}" onclick="chooseCategory(this)">${item.toLowerCase()}</div>`).join('');
    } else {
      document.getElementById('category-list-box').innerHTML = categories.map((item) => `<div class="category-item" category="${item}" onclick="chooseCategory(this)">${item.toLowerCase()}</div>`).join('');
    }
  })

  function searchAllDomain(target) {
    const inputEle = target.parentElement.querySelector('input:nth-child(1)');
    const keyword = inputEle.value.trim().toLowerCase();
    if (keyword) {
      let htmlStr = '';
      parseResult.forEach(item => {
        const rightDomains = item.domain.filter(item2 => item2.value.includes(keyword));
        if (rightDomains.length > 0) {
          htmlStr += `<div style="border-bottom:2px dashed #4397ff30;margin-bottom:10px;padding-bottom:10px">`;
          htmlStr += `<div style="font-weight:bold;">类别: ${item.category}</div>`;
          htmlStr += rightDomains.map(item2 => {
            const attrs = item2.attribute.map(attr => `<span style="margin-left:2px;color:purple;">@${attr.key}</span>`).join('');
            return `<div>
          <span style="color:green;">${domainTypeMap[item2.type]}:</span>
          <span style="margin-left:2px">${item2.value}</span>
          ${attrs}
          </div>
          `;
          }).join('');
          htmlStr += `</div>`;
        }
      });
      document.getElementById('search-domain-box').innerHTML = htmlStr;
    } else {
      document.getElementById('search-domain-box').innerHTML = '';
    }
  }

</script>

</html>
